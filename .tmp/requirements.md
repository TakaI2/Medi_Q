# 要件定義書 - Medi_Q スケジュール管理システム（自作版）

## ドキュメント情報
- **作成日**: 2025-11-30
- **バージョン**: 2.0
- **ステータス**: Draft
- **前バージョン**: 1.0（Google Calendar連携版）

---

## 1. 目的

### 1.1 プロジェクト背景
Medi_Q（QRコード来院者管理システム）において、Google Calendar連携を廃止し、自施設内で完結するスケジュール管理システムを構築する。

### 1.2 移行理由
| 課題 | Google Calendar | 自作システム |
|------|-----------------|-------------|
| データ管理 | 外部（Google）に依存 | 施設内で完結 |
| カスタマイズ性 | 固定フィールドのみ | 自由に設計可能 |
| オフライン動作 | 不可 | 可能 |
| 認証の複雑さ | OAuth 2.0設定が必要 | シンプル |
| QR表示内容 | カレンダー説明欄に埋め込み | 専用フィールドで管理 |

### 1.3 目標
1. 患者情報・スケジュール・QR表示内容を一元管理できるシステムの構築
2. 直感的なカレンダーUIによるスケジュール管理
3. 既存のQR受付・音声案内・印刷機能との統合

---

## 2. 機能要件

### 2.1 必須機能

#### F-101: 患者管理機能
- [ ] **F-101-01**: 患者一覧表示（検索・フィルタ・ページネーション）
- [ ] **F-101-02**: 患者新規登録（患者ID、氏名、ふりがな）
- [ ] **F-101-03**: 患者情報編集
- [ ] **F-101-04**: 患者削除（論理削除）
- [ ] **F-101-05**: 患者詳細画面でQRコード表示・ダウンロード・印刷（既存qrcodeライブラリ活用）
- [ ] **F-101-06**: QR表示内容のカスタマイズ（音声テンプレート、印刷テンプレート）

> **注**: 既存の `/test-qr` ページは削除し、患者詳細画面（/admin/patients/[id]）に統合する

#### F-102: スケジュール管理機能
- [ ] **F-102-01**: カレンダー表示（月表示）
- [ ] **F-102-02**: カレンダー表示（週表示）
- [ ] **F-102-03**: 日別予約一覧表示
- [ ] **F-102-04**: 予約新規登録（患者選択、日時、診察科、担当医、待機場所、検査内容）
- [ ] **F-102-05**: 予約編集
- [ ] **F-102-06**: 予約削除
- [ ] **F-102-07**: 来院ステータス管理（未来院/来院済み）
- [ ] **F-102-08**: 患者IDからの当日予約検索

#### F-103: マスタ管理機能
- [ ] **F-103-01**: 診察科マスタ管理（一覧、追加、編集、削除）
- [ ] **F-103-02**: 担当医マスタ管理（一覧、追加、編集、削除）
- [ ] **F-103-03**: 待機場所マスタ管理（一覧、追加、編集、削除）
- [ ] **F-103-04**: 検査項目マスタ管理（一覧、追加、編集、削除）

#### F-104: 認証機能
- [ ] **F-104-01**: 管理画面へのパスワード認証
- [ ] **F-104-02**: セッション管理（一定時間で自動ログアウト）
- [ ] **F-104-03**: パスワード変更機能

#### F-105: 受付連携機能（既存機能の改修）
- [ ] **F-105-01**: QRコード読取後、SQLiteから患者・予約情報を取得
- [ ] **F-105-02**: 来院時に予約ステータスを「来院済み」に更新
- [ ] **F-105-03**: 取得した情報で音声案内を生成
- [ ] **F-105-04**: 取得した情報で診察票を印刷

### 2.2 オプション機能

- [ ] **F-201**: 予約のドラッグ&ドロップ移動
- [ ] **F-202**: 予約の繰り返し設定（毎週、隔週等）
- [ ] **F-203**: 予約のCSVインポート/エクスポート
- [ ] **F-204**: 複数患者の一括QRコード印刷
- [ ] **F-205**: 来院統計ダッシュボード
- [ ] **F-206**: 予約のカラーラベル機能

---

## 3. 非機能要件

### 3.1 パフォーマンス
- **NFR-101**: 患者一覧の初期表示は1秒以内
- **NFR-102**: カレンダー月表示の切り替えは0.5秒以内
- **NFR-103**: QRコード読取から情報表示までは2秒以内
- **NFR-104**: 同時接続数: 最大5ユーザー（管理画面）

### 3.2 セキュリティ
- **NFR-105**: 管理画面はパスワード認証必須
- **NFR-106**: パスワードはハッシュ化して保存（bcrypt）
- **NFR-107**: セッションは8時間で自動失効
- **NFR-108**: 患者情報は画面表示後30秒で自動クリア（受付画面）
- **NFR-109**: SQLiteファイルはアプリケーション外からアクセス不可

### 3.3 保守性
- **NFR-110**: Prisma ORMによる型安全なDB操作
- **NFR-111**: API層とUI層の明確な分離
- **NFR-112**: エラーログの出力（日付・時刻・エラー内容）

### 3.4 互換性
- **NFR-113**: 既存のQRリーダー、音声合成、印刷機能との互換性維持
- **NFR-114**: 既存のUI/UXデザインとの一貫性

### 3.5 データ整合性
- **NFR-115**: 予約は必ず患者に紐付く（外部キー制約）
- **NFR-116**: 患者削除時は関連予約も論理削除
- **NFR-117**: マスタ削除時は使用中チェック

---

## 4. 制約事項

### 4.1 技術的制約
| 項目 | 制約内容 |
|------|---------|
| **データベース** | SQLite（ファイルベース） |
| **ORM** | Prisma |
| **フレームワーク** | Next.js（既存）|
| **UIライブラリ** | Tailwind CSS（既存）|
| **認証方式** | 固定パスワード（環境変数管理）|

### 4.2 運用的制約
- 管理画面は院内ネットワークからのみアクセス想定
- 同時編集の競合制御は実装しない（小規模運用前提）
- バックアップは手動（SQLiteファイルのコピー）

---

## 5. 成功基準

### 5.1 完了の定義

- [ ] 患者の登録・編集・削除・検索ができること
- [ ] カレンダーUIで予約の閲覧・登録・編集・削除ができること
- [ ] QRコード読取で患者・予約情報がDBから取得できること
- [ ] 取得した情報で音声案内・印刷が正常動作すること
- [ ] 管理画面にパスワード認証が適用されていること
- [ ] Google Calendar関連のコードが削除されていること

### 5.2 受け入れテスト

1. **患者管理**: 新規患者を登録し、QRコードを生成できる
2. **予約管理**: カレンダーから予約を作成し、編集できる
3. **受付フロー**: QRコードをスキャンして、音声案内・印刷が動作する
4. **認証**: パスワードなしで管理画面にアクセスできない

---

## 6. データモデル

### 6.1 エンティティ関連図

```
┌──────────────┐       ┌──────────────┐
│   Patient    │       │   Schedule   │
├──────────────┤       ├──────────────┤
│ id (PK)      │──┐    │ id (PK)      │
│ patientCode  │  │    │ patientId(FK)│←─┘
│ name         │  │    │ date         │
│ nameKana     │  │    │ startTime    │
│ voiceTemplate│  │    │ endTime      │
│ printTemplate│  │    │ departmentId │
│ isDeleted    │  │    │ doctorId     │
│ createdAt    │  │    │ waitingAreaId│
│ updatedAt    │  │    │ examinations │
└──────────────┘  │    │ status       │
                  │    │ visitedAt    │
┌──────────────┐  │    │ isDeleted    │
│  Department  │  │    │ createdAt    │
├──────────────┤  │    │ updatedAt    │
│ id (PK)      │←─┼────┤              │
│ name         │  │    └──────────────┘
│ isDeleted    │  │
└──────────────┘  │    ┌──────────────┐
                  │    │    Doctor    │
┌──────────────┐  │    ├──────────────┤
│ WaitingArea  │  │    │ id (PK)      │
├──────────────┤  │    │ name         │
│ id (PK)      │←─┼────│ departmentId │
│ name         │  │    │ isDeleted    │
│ isDeleted    │  │    └──────────────┘
└──────────────┘  │
                  │    ┌──────────────┐
                  │    │ Examination  │
                  │    ├──────────────┤
                  └────│ id (PK)      │
                       │ name         │
                       │ isDeleted    │
                       └──────────────┘
```

### 6.2 主要フィールド詳細

#### Patient（患者）
| フィールド | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| id | Int | Yes | 自動採番ID |
| patientCode | String | Yes | 患者ID（QRコード値、例: P12345）|
| name | String | Yes | 患者氏名 |
| nameKana | String | Yes | ふりがな（音声案内用）|
| voiceTemplate | String | No | 音声案内カスタムテンプレート |
| printTemplate | String | No | 印刷カスタムテンプレート |
| isDeleted | Boolean | Yes | 論理削除フラグ |

#### Schedule（予約）
| フィールド | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| id | Int | Yes | 自動採番ID |
| patientId | Int | Yes | 患者ID（FK）|
| date | Date | Yes | 予約日 |
| startTime | String | Yes | 開始時刻（HH:mm）|
| endTime | String | No | 終了時刻（HH:mm）|
| departmentId | Int | Yes | 診察科ID（FK）|
| doctorId | Int | Yes | 担当医ID（FK）|
| waitingAreaId | Int | Yes | 待機場所ID（FK）|
| examinations | String | No | 検査内容（JSON配列）|
| status | String | Yes | ステータス（scheduled/visited/cancelled）|
| visitedAt | DateTime | No | 来院日時 |

---

## 7. 画面一覧

### 7.1 管理画面（/admin）

| 画面ID | 画面名 | パス | 説明 |
|--------|--------|------|------|
| A-001 | ログイン | /admin/login | パスワード入力画面 |
| A-002 | ダッシュボード | /admin | 本日の予約一覧、統計 |
| A-003 | 患者一覧 | /admin/patients | 患者の検索・一覧表示 |
| A-004 | 患者詳細 | /admin/patients/[id] | 患者情報編集、QRコード表示 |
| A-005 | 患者登録 | /admin/patients/new | 新規患者登録 |
| A-006 | カレンダー | /admin/schedules | 月/週カレンダー表示 |
| A-007 | 予約詳細 | /admin/schedules/[id] | 予約情報編集 |
| A-008 | 予約登録 | /admin/schedules/new | 新規予約登録 |
| A-009 | マスタ管理 | /admin/masters | 診察科・担当医・待機場所・検査項目 |
| A-010 | 設定 | /admin/settings | パスワード変更、システム設定 |

### 7.2 受付画面（/）

| 画面ID | 画面名 | パス | 説明 |
|--------|--------|------|------|
| R-001 | QR受付 | / | QRコード読取、患者情報表示（既存改修）|

---

## 8. 想定されるリスク

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| SQLiteファイル破損 | 高 | 低 | 定期バックアップ運用ルール策定 |
| 同時編集による競合 | 中 | 低 | 楽観的ロック or 運用で回避 |
| パスワード漏洩 | 高 | 低 | 環境変数管理、定期変更 |
| カレンダーUI実装の遅延 | 中 | 中 | ライブラリ選定で工数削減 |

---

## 9. 今後の検討事項

### 設計フェーズで詳細化すべき事項

1. **カレンダーUIライブラリ選定**: FullCalendar vs react-big-calendar vs 自作
2. **認証の詳細設計**: セッション管理方法（Cookie vs JWT）
3. **バックアップ方式**: 自動化の可否、世代管理
4. **移行計画**: 既存モックデータの扱い

---

## 10. 削除対象（Google Calendar連携）

以下のファイル・機能を削除する:

### 10.1 削除対象ファイル
- `app/api/calendar/search/route.ts`
- `app/api/calendar/notify/route.ts`
- `lib/calendar.ts`（Google Calendar連携関数）
- `app/test-qr/page.tsx`（QR生成テストページ → 患者詳細画面に統合）

### 10.2 削除対象環境変数
- `GOOGLE_CALENDAR_ID`
- `GOOGLE_SERVICE_ACCOUNT_EMAIL`
- `GOOGLE_PRIVATE_KEY`

### 10.3 削除対象依存パッケージ
- `googleapis`
- `google-auth-library`

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|---------|--------|
| 2025-11-14 | 1.0 | 初版作成（Google Calendar連携版）| Claude |
| 2025-11-30 | 2.0 | 自作スケジュール管理システムへ移行 | Claude |
