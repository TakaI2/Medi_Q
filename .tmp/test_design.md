# テスト設計書 - Medi_Q スケジュール管理システム（自作版）

## ドキュメント情報
- **作成日**: 2025-11-14
- **更新日**: 2025-11-30
- **バージョン**: 2.0
- **ステータス**: Draft
- **関連ドキュメント**: requirements.md (v2.0), design.md (v2.0)

---

## 1. テスト戦略

### 1.1 テスト目的
- 要件定義書 v2.0 に記載された全機能が正常に動作することを確認
- SQLite + Prisma ベースの新アーキテクチャの信頼性を検証
- システムのパフォーマンス、セキュリティ、ユーザビリティを検証

### 1.2 テストレベル

| テストレベル | 実施者 | 目的 | タイミング |
|------------|--------|------|----------|
| **単体テスト** | 開発者 | 個別関数・コンポーネントの動作検証 | 開発中 |
| **統合テスト** | 開発者 | API・DB連携の検証 | 開発後 |
| **システムテスト** | QA/開発者 | システム全体の機能・非機能要件の検証 | 統合テスト後 |
| **受入テスト** | エンドユーザー | 実際の運用環境での動作確認 | システムテスト後 |

### 1.3 テスト環境

#### ハードウェア
- PC: Windows 10/11、メモリ8GB以上
- Webカメラ: Logicool C920x または同等品
- プリンタ: Canon PIXUS TS3530 または同等品

#### ソフトウェア
- ブラウザ: Chrome 100+、Edge 100+
- Node.js: 18.x以上
- VOICEVOX Engine: 最新版
- SQLite: 3.x（Prisma経由）

#### テストデータ
- SQLiteテスト用DB（prisma/test.db）
- テスト用患者データ（P00001 〜 P00010）
- テスト用QRコード印刷物

---

## 2. 機能テスト

### 2.1 患者管理機能（F-101）

#### TC-F101-01: 患者一覧表示

| 項目 | 内容 |
|------|------|
| **テストID** | TC-F101-01 |
| **対応要件** | F-101-01 |
| **優先度** | 高 |
| **前提条件** | - 管理者としてログイン済み<br>- テスト用患者データが登録済み |
| **テスト手順** | 1. 患者管理画面（/admin/patients）にアクセス<br>2. 患者一覧が表示されることを確認<br>3. 検索ボックスに「山田」と入力<br>4. フィルタ結果を確認 |
| **期待結果** | - 患者一覧が表示される<br>- ページネーションが機能する<br>- 検索で「山田」を含む患者のみ表示される |

#### TC-F101-02: 患者新規登録

| 項目 | 内容 |
|------|------|
| **テストID** | TC-F101-02 |
| **対応要件** | F-101-02 |
| **優先度** | 高 |
| **前提条件** | - 管理者としてログイン済み |
| **テスト手順** | 1. 患者登録画面（/admin/patients/new）にアクセス<br>2. 患者ID「P99001」、氏名「テスト太郎」、ふりがな「てすとたろう」を入力<br>3. 登録ボタンをクリック |
| **期待結果** | - 患者が正常に登録される<br>- 患者詳細画面にリダイレクトされる<br>- QRコードが自動生成される |

#### TC-F101-03: 患者ID重複エラー

| 項目 | 内容 |
|------|------|
| **テストID** | TC-F101-03 |
| **対応要件** | F-101-02 |
| **優先度** | 中 |
| **前提条件** | - 患者ID「P00001」が既に登録済み |
| **テスト手順** | 1. 患者登録画面にアクセス<br>2. 既存の患者ID「P00001」を入力<br>3. 登録ボタンをクリック |
| **期待結果** | - エラーメッセージ「この患者IDは既に使用されています」が表示される<br>- 登録は実行されない |

#### TC-F101-04: 患者詳細・QRコード表示

| 項目 | 内容 |
|------|------|
| **テストID** | TC-F101-04 |
| **対応要件** | F-101-05 |
| **優先度** | 高 |
| **前提条件** | - 患者ID「P00001」が登録済み |
| **テスト手順** | 1. 患者詳細画面（/admin/patients/1）にアクセス<br>2. QRコードが表示されることを確認<br>3. ダウンロードボタンをクリック<br>4. 印刷ボタンをクリック |
| **期待結果** | - 患者情報が正しく表示される<br>- QRコードが表示され、患者IDが読み取れる<br>- ダウンロードでPNG画像が保存される<br>- 印刷ダイアログが表示される |

#### TC-F101-05: 患者削除（論理削除）

| 項目 | 内容 |
|------|------|
| **テストID** | TC-F101-05 |
| **対応要件** | F-101-04 |
| **優先度** | 中 |
| **前提条件** | - テスト用患者が登録済み |
| **テスト手順** | 1. 患者詳細画面で削除ボタンをクリック<br>2. 確認ダイアログで「削除」を選択<br>3. 患者一覧画面を確認 |
| **期待結果** | - 確認ダイアログが表示される<br>- 削除後、患者一覧から該当患者が非表示になる<br>- DBでisDeleted=trueになっている（物理削除されていない） |

---

### 2.2 スケジュール管理機能（F-102）

#### TC-F102-01: カレンダー月表示

| 項目 | 内容 |
|------|------|
| **テストID** | TC-F102-01 |
| **対応要件** | F-102-01 |
| **優先度** | 高 |
| **前提条件** | - 管理者としてログイン済み<br>- 当月の予約データが存在 |
| **テスト手順** | 1. スケジュール画面（/admin/schedules）にアクセス<br>2. 月表示モードで表示されることを確認<br>3. 前月・次月ボタンで月を切り替え |
| **期待結果** | - 当月のカレンダーが表示される<br>- 予約がある日付に件数が表示される<br>- 月の切り替えが正常に動作する |

#### TC-F102-02: カレンダー週表示

| 項目 | 内容 |
|------|------|
| **テストID** | TC-F102-02 |
| **対応要件** | F-102-02 |
| **優先度** | 中 |
| **前提条件** | - 管理者としてログイン済み |
| **テスト手順** | 1. カレンダー画面で「週」表示に切り替え<br>2. 時間軸表示で予約が表示されることを確認 |
| **期待結果** | - 週表示に切り替わる<br>- 予約が時間帯別に表示される |

#### TC-F102-03: 予約新規登録

| 項目 | 内容 |
|------|------|
| **テストID** | TC-F102-03 |
| **対応要件** | F-102-04 |
| **優先度** | 高 |
| **前提条件** | - 患者、診察科、担当医、待機場所が登録済み |
| **テスト手順** | 1. 予約登録画面（/admin/schedules/new）にアクセス<br>2. 患者「P00001」を選択<br>3. 日付「2025-12-01」、時刻「10:00」を設定<br>4. 診察科「内科」、担当医「田中花子」、待機場所「2階待合室A」を選択<br>5. 検査項目「血液検査」にチェック<br>6. 登録ボタンをクリック |
| **期待結果** | - 予約が正常に登録される<br>- カレンダーに予約が表示される |

#### TC-F102-04: 予約編集

| 項目 | 内容 |
|------|------|
| **テストID** | TC-F102-04 |
| **対応要件** | F-102-05 |
| **優先度** | 高 |
| **前提条件** | - テスト用予約が登録済み |
| **テスト手順** | 1. 予約詳細画面にアクセス<br>2. 時刻を「11:00」に変更<br>3. 更新ボタンをクリック |
| **期待結果** | - 予約情報が更新される<br>- 更新後の情報がカレンダーに反映される |

#### TC-F102-05: 予約キャンセル

| 項目 | 内容 |
|------|------|
| **テストID** | TC-F102-05 |
| **対応要件** | F-102-06 |
| **優先度** | 中 |
| **前提条件** | - テスト用予約が登録済み |
| **テスト手順** | 1. 予約詳細画面で「キャンセル」ボタンをクリック<br>2. 確認ダイアログで「キャンセル」を選択 |
| **期待結果** | - 予約ステータスが「cancelled」に変更される<br>- カレンダーでの表示が変わる（取り消し線等） |

#### TC-F102-06: 患者IDからの当日予約検索

| 項目 | 内容 |
|------|------|
| **テストID** | TC-F102-06 |
| **対応要件** | F-102-08 |
| **優先度** | 高 |
| **前提条件** | - 当日の予約が登録済み |
| **テスト手順** | 1. GET /api/schedules?patientCode=P00001&date=今日 を実行<br>2. レスポンスを確認 |
| **期待結果** | - 該当患者の当日予約情報が返される<br>- 予約がない場合は空配列 |

---

### 2.3 マスタ管理機能（F-103）

#### TC-F103-01: 診察科マスタ管理

| 項目 | 内容 |
|------|------|
| **テストID** | TC-F103-01 |
| **対応要件** | F-103-01 |
| **優先度** | 中 |
| **前提条件** | - 管理者としてログイン済み |
| **テスト手順** | 1. マスタ管理画面（/admin/masters）にアクセス<br>2. 「診察科」タブを選択<br>3. 新規追加：「皮膚科」を登録<br>4. 編集：「皮膚科」→「皮膚科・形成外科」に変更<br>5. 削除：登録した項目を削除 |
| **期待結果** | - 診察科一覧が表示される<br>- 追加・編集・削除が正常に動作する |

#### TC-F103-02: 担当医マスタ - 診察科連動

| 項目 | 内容 |
|------|------|
| **テストID** | TC-F103-02 |
| **対応要件** | F-103-02 |
| **優先度** | 中 |
| **前提条件** | - 診察科「内科」「外科」が登録済み |
| **テスト手順** | 1. 担当医マスタで新規追加<br>2. 所属診察科を「内科」に設定して登録<br>3. 予約登録画面で診察科を「内科」に変更<br>4. 担当医選択肢を確認 |
| **期待結果** | - 担当医が診察科に紐付いて登録される<br>- 予約登録時、選択した診察科の担当医のみ表示される |

#### TC-F103-03: マスタ使用中チェック

| 項目 | 内容 |
|------|------|
| **テストID** | TC-F103-03 |
| **対応要件** | NFR-117 |
| **優先度** | 中 |
| **前提条件** | - 診察科「内科」を使用した予約が存在 |
| **テスト手順** | 1. マスタ管理画面で「内科」の削除を試行 |
| **期待結果** | - エラーメッセージ「この診察科は使用中のため削除できません」が表示される<br>- 削除は実行されない |

---

### 2.4 認証機能（F-104）

#### TC-F104-01: ログイン - 正常系

| 項目 | 内容 |
|------|------|
| **テストID** | TC-F104-01 |
| **対応要件** | F-104-01 |
| **優先度** | 高 |
| **前提条件** | - 管理者アカウントが存在（username: admin） |
| **テスト手順** | 1. ログイン画面（/admin/login）にアクセス<br>2. ユーザー名「admin」、パスワードを入力<br>3. ログインボタンをクリック |
| **期待結果** | - ログインが成功する<br>- ダッシュボード（/admin）にリダイレクトされる<br>- HttpOnly Cookieにトークンがセットされる |

#### TC-F104-02: ログイン - 異常系（パスワード誤り）

| 項目 | 内容 |
|------|------|
| **テストID** | TC-F104-02 |
| **対応要件** | F-104-01 |
| **優先度** | 高 |
| **前提条件** | - 管理者アカウントが存在 |
| **テスト手順** | 1. ログイン画面で誤ったパスワードを入力<br>2. ログインボタンをクリック |
| **期待結果** | - エラーメッセージ「ユーザー名またはパスワードが正しくありません」が表示される<br>- ログインできない |

#### TC-F104-03: 未認証アクセス拒否

| 項目 | 内容 |
|------|------|
| **テストID** | TC-F104-03 |
| **対応要件** | F-104-01 |
| **優先度** | 高 |
| **前提条件** | - ログインしていない状態 |
| **テスト手順** | 1. 直接 /admin にアクセス<br>2. 直接 /api/patients にアクセス |
| **期待結果** | - /admin: ログイン画面にリダイレクトされる<br>- /api/patients: 401 Unauthorized が返される |

#### TC-F104-04: セッション自動失効

| 項目 | 内容 |
|------|------|
| **テストID** | TC-F104-04 |
| **対応要件** | F-104-02 |
| **優先度** | 中 |
| **前提条件** | - ログイン済み |
| **テスト手順** | 1. JWTトークンの有効期限を短く設定（テスト用に1分）<br>2. ログイン後、1分以上待機<br>3. 管理画面の操作を試行 |
| **期待結果** | - セッション失効後、ログイン画面にリダイレクトされる |

#### TC-F104-05: パスワード変更

| 項目 | 内容 |
|------|------|
| **テストID** | TC-F104-05 |
| **対応要件** | F-104-03 |
| **優先度** | 中 |
| **前提条件** | - ログイン済み |
| **テスト手順** | 1. 設定画面（/admin/settings）にアクセス<br>2. 現在のパスワード、新しいパスワードを入力<br>3. 変更ボタンをクリック<br>4. ログアウト後、新しいパスワードでログイン |
| **期待結果** | - パスワードが正常に変更される<br>- 新しいパスワードでログインできる |

---

### 2.5 受付連携機能（F-105）

#### TC-F105-01: QRコード読取 → 患者情報取得

| 項目 | 内容 |
|------|------|
| **テストID** | TC-F105-01 |
| **対応要件** | F-105-01 |
| **優先度** | 高 |
| **前提条件** | - 患者「P00001」と当日の予約が登録済み<br>- Webカメラが接続済み |
| **テスト手順** | 1. 受付画面（/）にアクセス<br>2. QRコード「P00001」をカメラにかざす<br>3. 患者情報表示を確認 |
| **期待結果** | - QRコードが正常に読み取られる<br>- SQLiteから患者・予約情報が取得される<br>- 患者名、診察科、担当医、待機場所、検査内容が表示される |

#### TC-F105-02: 来院ステータス更新

| 項目 | 内容 |
|------|------|
| **テストID** | TC-F105-02 |
| **対応要件** | F-105-02 |
| **優先度** | 高 |
| **前提条件** | - 予約ステータスが「scheduled」 |
| **テスト手順** | 1. QRコードを読み取り、患者情報を表示<br>2. DBの予約レコードを確認 |
| **期待結果** | - 予約ステータスが「visited」に更新される<br>- visitedAtに来院日時が記録される |

#### TC-F105-03: 予約なしの患者

| 項目 | 内容 |
|------|------|
| **テストID** | TC-F105-03 |
| **対応要件** | F-105-01 |
| **優先度** | 高 |
| **前提条件** | - 患者「P99999」は登録されているが当日予約なし |
| **テスト手順** | 1. QRコード「P99999」をカメラにかざす |
| **期待結果** | - エラーメッセージ「本日の診察予定が見つかりませんでした」が表示される<br>- 受付スタッフへの連絡を促すメッセージが表示される |

#### TC-F105-04: 未登録患者

| 項目 | 内容 |
|------|------|
| **テストID** | TC-F105-04 |
| **対応要件** | F-105-01 |
| **優先度** | 高 |
| **前提条件** | - 患者「PXXXXX」がDBに存在しない |
| **テスト手順** | 1. 存在しない患者IDのQRコードをかざす |
| **期待結果** | - エラーメッセージ「患者情報が見つかりませんでした」が表示される |

#### TC-F105-05: 音声案内生成

| 項目 | 内容 |
|------|------|
| **テストID** | TC-F105-05 |
| **対応要件** | F-105-03 |
| **優先度** | 高 |
| **前提条件** | - VOICEVOX Engineが起動中<br>- 予約データあり |
| **テスト手順** | 1. QRコードを読み取り、患者情報を表示<br>2. 音声案内が自動再生されることを確認 |
| **期待結果** | - 音声が自動再生される<br>- 音声内容に患者名、診察科、待機場所、担当医が含まれる |

#### TC-F105-06: 診察票印刷

| 項目 | 内容 |
|------|------|
| **テストID** | TC-F105-06 |
| **対応要件** | F-105-04 |
| **優先度** | 中 |
| **前提条件** | - プリンタ接続済み |
| **テスト手順** | 1. 患者情報表示後、「診察票を印刷」ボタンをクリック<br>2. 印刷内容を確認 |
| **期待結果** | - 印刷ダイアログが表示される<br>- 印刷物に患者名、診察日時、診察科、担当医、待機場所、検査内容が含まれる |

---

## 3. 非機能テスト

### 3.1 パフォーマンステスト

#### TC-NFR101: 患者一覧表示速度

| 項目 | 内容 |
|------|------|
| **テストID** | TC-NFR101 |
| **要件** | NFR-101: 患者一覧の初期表示は1秒以内 |
| **前提条件** | - 患者データ1000件登録済み |
| **テスト手順** | 1. 患者一覧画面にアクセス<br>2. 初期表示までの時間を計測（10回） |
| **期待結果** | - 平均表示時間が1秒以内 |

#### TC-NFR102: カレンダー月表示切替速度

| 項目 | 内容 |
|------|------|
| **テストID** | TC-NFR102 |
| **要件** | NFR-102: カレンダー月表示の切り替えは0.5秒以内 |
| **テスト手順** | 1. カレンダー画面で月を切り替え<br>2. 表示完了までの時間を計測（10回） |
| **期待結果** | - 平均切替時間が0.5秒以内 |

#### TC-NFR103: QRコード読取から情報表示

| 項目 | 内容 |
|------|------|
| **テストID** | TC-NFR103 |
| **要件** | NFR-103: QRコード読取から情報表示までは2秒以内 |
| **テスト手順** | 1. QRコードを読み取る<br>2. 患者情報が表示されるまでの時間を計測（10回） |
| **期待結果** | - 平均処理時間が2秒以内 |

#### TC-NFR104: 同時接続テスト

| 項目 | 内容 |
|------|------|
| **テストID** | TC-NFR104 |
| **要件** | NFR-104: 同時接続数5ユーザー対応 |
| **テスト手順** | 1. 5つのブラウザセッションで同時に管理画面を操作<br>2. 全セッションで正常に動作することを確認 |
| **期待結果** | - 全セッションで正常に動作する<br>- レスポンス時間に大きな劣化がない |

### 3.2 セキュリティテスト

#### TC-NFR105: パスワード認証必須

| 項目 | 内容 |
|------|------|
| **テストID** | TC-NFR105 |
| **要件** | NFR-105: 管理画面はパスワード認証必須 |
| **テスト手順** | 1. 未認証状態で /admin/* にアクセス<br>2. 未認証状態で /api/* にアクセス（受付・音声API除く） |
| **期待結果** | - 全て認証エラーまたはリダイレクト |

#### TC-NFR106: パスワードハッシュ化

| 項目 | 内容 |
|------|------|
| **テストID** | TC-NFR106 |
| **要件** | NFR-106: パスワードはbcryptでハッシュ化 |
| **テスト手順** | 1. DBのAdminテーブルを直接確認<br>2. passwordHashフィールドの値を確認 |
| **期待結果** | - パスワードは平文で保存されていない<br>- bcryptハッシュ形式（$2b$...）で保存されている |

#### TC-NFR108: 患者情報自動クリア

| 項目 | 内容 |
|------|------|
| **テストID** | TC-NFR108 |
| **要件** | NFR-108: 患者情報は画面表示後30秒で自動クリア |
| **テスト手順** | 1. QRコードを読み取り、患者情報を表示<br>2. 30秒間待機 |
| **期待結果** | - 30秒後に画面が自動クリアされる<br>- QRリーダー画面に戻る |

#### TC-NFR109: SQLiteファイルアクセス制限

| 項目 | 内容 |
|------|------|
| **テストID** | TC-NFR109 |
| **要件** | NFR-109: SQLiteファイルは外部アクセス不可 |
| **テスト手順** | 1. ブラウザから /prisma/medi_q.db にアクセス試行 |
| **期待結果** | - 404またはアクセス拒否が返される<br>- DBファイルがダウンロードされない |

### 3.3 データ整合性テスト

#### TC-NFR115: 予約-患者紐付け

| 項目 | 内容 |
|------|------|
| **テストID** | TC-NFR115 |
| **要件** | NFR-115: 予約は必ず患者に紐付く |
| **テスト手順** | 1. 患者IDなしで予約登録APIを呼び出す |
| **期待結果** | - バリデーションエラーが返される |

#### TC-NFR116: 患者削除時の予約連動

| 項目 | 内容 |
|------|------|
| **テストID** | TC-NFR116 |
| **要件** | NFR-116: 患者削除時は関連予約も論理削除 |
| **テスト手順** | 1. 予約がある患者を論理削除<br>2. 関連予約のisDeletedフラグを確認 |
| **期待結果** | - 患者のisDeleted=true<br>- 関連予約もisDeleted=true |

---

## 4. 統合テストシナリオ

### 4.1 シナリオ1: 新規患者登録〜来院フロー

| ステップ | 操作 | 期待結果 |
|---------|------|---------|
| 1 | 管理者ログイン | ダッシュボードが表示される |
| 2 | 患者管理 → 新規登録 | 患者登録フォームが表示される |
| 3 | 患者情報入力・登録 | 患者が登録され、QRコードが生成される |
| 4 | QRコードを印刷 | 診察券用QRコードが印刷される |
| 5 | スケジュール → 新規予約 | 予約登録フォームが表示される |
| 6 | 予約情報入力・登録 | 予約がカレンダーに表示される |
| 7 | 受付画面でQRコード読取 | 患者・予約情報が表示される |
| 8 | 音声案内再生 | 案内音声が再生される |
| 9 | 診察票印刷 | 診察票が印刷される |
| 10 | 予約ステータス確認 | 「来院済み」に更新されている |

### 4.2 シナリオ2: 予約変更フロー

| ステップ | 操作 | 期待結果 |
|---------|------|---------|
| 1 | カレンダーで予約をクリック | 予約詳細画面が表示される |
| 2 | 日時を変更 | 新しい日時が入力される |
| 3 | 更新ボタンをクリック | 予約が更新される |
| 4 | カレンダーを確認 | 新しい日時に予約が表示される |

### 4.3 シナリオ3: エラーハンドリング

| ステップ | 操作 | 期待結果 |
|---------|------|---------|
| 1 | 存在しない患者IDでQR読取 | エラーメッセージが表示される |
| 2 | 予約なしの患者でQR読取 | 「本日の予約なし」メッセージが表示される |
| 3 | VOICEVOX未起動で音声再生 | テキスト表示にフォールバック |
| 4 | 不正なQRコードを読取 | 「無効なQRコード」メッセージ |

---

## 5. 受入テスト

### 5.1 受入テスト基準

| 項目 | 基準 |
|------|------|
| **機能要件** | 全ての機能テストケースが合格（重大バグ0件） |
| **非機能要件** | パフォーマンス・セキュリティテストが全て合格 |
| **ユーザビリティ** | スタッフ・患者モニターからの肯定的フィードバック |
| **データ整合性** | 不整合データが発生しない |

### 5.2 チェックリスト

- [ ] 患者登録〜QRコード印刷ができる
- [ ] 予約登録〜カレンダー表示ができる
- [ ] QRコード読取〜情報表示〜音声案内〜印刷ができる
- [ ] 来院時に予約ステータスが自動更新される
- [ ] 管理画面はパスワードなしでアクセスできない
- [ ] Google Calendar関連のコードが削除されている
- [ ] SQLiteに全データが正しく保存される

---

## 6. テストツール

### 6.1 自動テスト

| ツール | 用途 |
|-------|------|
| **Vitest** | 単体テスト（関数、ユーティリティ） |
| **React Testing Library** | コンポーネントテスト |
| **Playwright** | E2Eテスト |
| **Prisma Mock** | DBモック |

### 6.2 手動テスト支援

| ツール | 用途 |
|-------|------|
| **Prisma Studio** | DBデータ確認・編集 |
| **Chrome DevTools** | ネットワーク・パフォーマンス |
| **Lighthouse** | パフォーマンス・アクセシビリティ |

---

## 7. テストデータ

### 7.1 テスト用患者データ

| 患者ID | 患者名 | ふりがな | 備考 |
|--------|-------|---------|------|
| P00001 | 山田太郎 | やまだたろう | 通常テスト用 |
| P00002 | 佐藤花子 | さとうはなこ | 通常テスト用 |
| P00003 | 鈴木次郎 | すずきじろう | 検査なしテスト用 |
| P99999 | テスト削除 | てすとさくじょ | 削除テスト用 |

### 7.2 テスト用マスタデータ

**診察科**: 内科、外科、小児科、整形外科、眼科
**待機場所**: 1階待合室A、1階待合室B、2階待合室A、2階待合室B
**検査項目**: 血液検査、X線撮影、MRI、CT、心電図

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|---------|--------|
| 2025-11-14 | 1.0 | 初版作成（Google Calendar連携版） | Claude |
| 2025-11-30 | 2.0 | SQLite + Prisma版に全面改訂 | Claude |
