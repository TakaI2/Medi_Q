# 🔢 患者コード自動生成機能

**実装日**: 2026-01-12
**機能**: 患者登録時に患者コードを自動採番する機能

---

## 📋 機能概要

患者登録時に患者コード（例: P00001, P00002）を**自動的に生成**し、手動入力を不要にしました。

### 変更前
- ❌ 患者コードを手動入力する必要があった
- ❌ 重複チェックが必要
- ❌ ユーザーがフォーマットを間違える可能性があった

### 変更後
- ✅ 患者コードが自動で採番される
- ✅ 重複の心配がない
- ✅ 常に正しいフォーマット（P + 5桁数字）

---

## 🎯 患者コードのフォーマット

### 形式
```
P + 5桁の数字（ゼロパディング）
```

### 例
- 最初の患者: `P00001`
- 2番目の患者: `P00002`
- 100番目の患者: `P00100`
- 最大: `P99999`（99,999人まで対応）

---

## 🔧 実装詳細

### 1. API修正（`app/api/patients/route.ts`）

#### 自動生成ロジック

```typescript
// 患者コード自動生成
const latestPatient = await prisma.patient.findFirst({
  where: { isDeleted: false },
  orderBy: { patientCode: 'desc' },
});

let nextPatientCode = 'P00001';
if (latestPatient) {
  // 既存の患者コードから数値部分を抽出
  const match = latestPatient.patientCode.match(/^P(\d+)$/);
  if (match) {
    const nextNumber = parseInt(match[1], 10) + 1;
    if (nextNumber > 99999) {
      return NextResponse.json(
        {
          success: false,
          error: {
            code: ErrorCode.VALIDATION_ERROR,
            message: '患者コードの上限に達しました（P99999）',
          },
        },
        { status: 400 }
      );
    }
    nextPatientCode = `P${nextNumber.toString().padStart(5, '0')}`;
  }
}

const patient = await prisma.patient.create({
  data: {
    patientCode: nextPatientCode,
    name: body.name,
    nameKana: body.nameKana,
    voiceTemplate: body.voiceTemplate ?? null,
    printTemplate: body.printTemplate ?? null,
  },
});
```

#### アルゴリズム

1. **最新の患者コードを取得**
   - 削除されていない患者の中から最大の患者コードを取得
   - `orderBy: { patientCode: 'desc' }` で降順ソート

2. **次の番号を計算**
   - 正規表現 `/^P(\d+)$/` で数値部分を抽出
   - `parseInt()` で数値に変換して +1
   - `padStart(5, '0')` でゼロパディング

3. **上限チェック**
   - 99,999を超えたらエラーを返す

4. **患者を登録**
   - 自動生成された患者コードで登録

---

### 2. 患者登録画面修正（`app/admin/patients/new/page.tsx`）

#### 変更点

1. **患者コード入力フィールドを削除**
   ```typescript
   // 削除: const [patientCode, setPatientCode] = useState('');
   ```

2. **フォーム送信時に患者コードを送信しない**
   ```typescript
   // 変更前
   body: JSON.stringify({
     patientCode,  // ❌ 削除
     name,
     nameKana,
   }),

   // 変更後
   body: JSON.stringify({
     name,
     nameKana,
   }),
   ```

3. **説明メッセージを追加**
   ```jsx
   {/* 患者コード自動生成の説明 */}
   <div className="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
     <p className="text-sm text-blue-800">
       <strong>📝 患者コード:</strong> 登録時に自動的に採番されます（P00001, P00002, ...）
     </p>
   </div>
   ```

---

## 🧪 テスト手順

### 1. 新規患者登録テスト

1. http://localhost:3000/admin/patients/new にアクセス
2. **確認**: 患者コード入力フィールドが表示されない
3. **確認**: 青い背景の説明メッセージが表示される
4. 氏名に「テスト太郎」と入力
5. ふりがなに「てすとたろう」と入力
6. 「登録する」ボタンをクリック
7. **期待結果**:
   - ✅ 登録が成功する
   - ✅ 患者詳細ページにリダイレクトされる
   - ✅ 患者コードが自動生成されている（例: P00004）
   - ✅ QRコードが表示される

### 2. 連続登録テスト

1. 新規患者を3人登録
   - 患者1: 「テスト太郎」
   - 患者2: 「テスト花子」
   - 患者3: 「テスト次郎」
2. 患者一覧画面で確認
3. **期待結果**:
   - ✅ 患者コードが連番になっている（P00004, P00005, P00006）
   - ✅ 重複がない

### 3. データベース直接確認

```bash
# Prisma Studioで確認
cd app
npx prisma studio
```

1. Patientテーブルを開く
2. **期待結果**:
   - ✅ patientCodeが連番になっている
   - ✅ P + 5桁数字のフォーマットが正しい

---

## 📊 動作例

### シナリオ: 既存患者がP00003まで存在する場合

| 操作 | 登録される患者コード |
|------|---------------------|
| 新規患者登録1 | `P00004` |
| 新規患者登録2 | `P00005` |
| 新規患者登録3 | `P00006` |

### シナリオ: 初回の患者登録

| 操作 | 登録される患者コード |
|------|---------------------|
| 初回の患者登録 | `P00001` |

---

## ⚠️ 注意事項

### 上限について

- **最大患者数**: 99,999人（P00001 〜 P99999）
- **上限到達時**: エラーメッセージが表示され、登録できません

### 削除された患者について

- 削除された患者（`isDeleted: true`）は採番計算から除外されます
- 欠番が発生する可能性があります

**例**:
```
P00001 ✅ 有効
P00002 ❌ 削除済み（欠番）
P00003 ✅ 有効
→ 次の患者: P00004
```

### バックアップの重要性

患者コードは自動生成されるため、データベースのバックアップが重要です。
- データベースファイル: `app/prisma/medi_q.db`
- 定期的にバックアップを取ることを推奨

---

## 🔄 既存データへの影響

### 既存の患者データ

- ✅ 既存の患者コードはそのまま維持されます
- ✅ 手動で設定された患者コード（P00001〜P00003）も正常に動作します

### 互換性

- ✅ QRコード機能: 影響なし
- ✅ 予約機能: 影響なし
- ✅ 受付機能: 影響なし

---

## 📝 メリット

### 1. ユーザビリティ向上
- ✅ 入力項目が減って登録が簡単になった
- ✅ フォーマットを覚える必要がない

### 2. データ整合性
- ✅ 重複が発生しない
- ✅ 常に正しいフォーマット

### 3. 運用効率
- ✅ 登録時間の短縮
- ✅ 入力ミスの削減

---

## 🚀 今後の拡張案

### 1. プレフィックスのカスタマイズ

施設ごとに異なるプレフィックスを使用できるようにする

**例**:
- 施設A: `A00001`, `A00002`, ...
- 施設B: `B00001`, `B00002`, ...

### 2. 桁数の拡張

99,999人を超える大規模施設向けに6桁に拡張

**例**: `P000001`, `P000002`, ... `P999999`

### 3. 欠番の再利用

削除された患者の番号を再利用する機能

---

## ✅ まとめ

患者コード自動生成機能により、以下が実現されました：

1. ✅ **操作の簡素化**: 手動入力が不要
2. ✅ **データの一貫性**: 常に正しいフォーマット
3. ✅ **エラーの削減**: 重複や入力ミスがゼロ
4. ✅ **運用効率の向上**: 登録時間の短縮

この機能により、医療施設の受付業務がより効率的になります。

---

**実装者**: Claude Sonnet 4.5
**確認日時**: 2026-01-12
